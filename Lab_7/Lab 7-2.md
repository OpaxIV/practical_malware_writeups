# Lab 7
Important: Since my MD-Editor decided to deleted half of my work during a program restart, some of the text has been copied 1:1 from the references below. 

## Lab 7-2

Analyse the malware found in the file Lab07-02.exe

0. Initial Analysis
   
   - `main` at 0x401000
   
   - **Graph View:**
     
     - <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-22-11-54-48-image.png" title="" alt="" width="443">
   
   - **Interesting Functions/API-Calls:**
     
     - `OleInitialize` - Initializes the COM library on the current apartment, identifies the concurrency model as single-thread apartment (STA), and enables additional functionality.
       
       - **Definition:**
         
         - COM - **Component Object Model** (**COM**) is a [binary-interface](https://en.wikipedia.org/wiki/Application_Binary_Interface "Application Binary Interface") standard for [software components](https://en.wikipedia.org/wiki/Component-based_software_engineering "Component-based software engineering") introduced by [Microsoft](https://en.wikipedia.org/wiki/Microsoft "Microsoft") in 1993. It is used to enable [inter-process communication](https://en.wikipedia.org/wiki/Inter-process_communication "Inter-process communication") [object](https://en.wikipedia.org/wiki/Object_(computer_science) "Object (computer science)") creation in a large range of [programming languages](https://en.wikipedia.org/wiki/Programming_languages "Programming languages").
       
       - **Synthax:**
         
         - ```C
           HRESULT OleInitialize(
             [in] LPVOID pvReserved
           );
           ```
       
       - **Parameters:**
         
         - `[in] pvReserved` - This parameter is reserved and must be **NULL**.
       
       - **Return Value:**
         
         - `S_OK` - success
         
         - `S_FALSE` - COM library already intizialized on this apartment.
         
         - ...
       
       - **References:**
         
         - [Component Object Model - Wikipedia](https://en.wikipedia.org/wiki/Component_Object_Model)
         - [OleInitialize function (ole2.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/ole2/nf-ole2-oleinitialize)
     
     - `CoCreateInstance` - Creates and default-initializes a single object of the class associated with a specified CLSID.
       
       - **Synthax:**
         
         - ```c
           HRESULT CoCreateInstance(
             [in]  REFCLSID  rclsid,
             [in]  LPUNKNOWN pUnkOuter,
             [in]  DWORD     dwClsContext,
             [in]  REFIID    riid,
             [out] LPVOID    *ppv
           );
           ```
       
       - **Parameters:**
         
         - `[in] rclsid` - The CLSID associated with the data and code that will be used to create the object.
         
         - `[in] pUnkOuter` - If **NULL**, indicates that the object is not being created as part of an aggregate.
         
         - `[in] dwClsContext` - Context in which the code that manages the newly created object will run. The values are taken from the enumeration [CLSCTX](https://learn.microsoft.com/en-us/windows/desktop/api/wtypesbase/ne-wtypesbase-clsctx).
         
         - `[in] riid` - A reference to the identifier of the interface to be used to communicate with the object.
         
         - `[out] ppv` - Address of pointer variable that receives the interface pointer requested in *riid*. Upon successful return, *ppv contains the requested interface pointer. Upon failure, *ppv contains **NULL**.
       
       - **Return Values:**
         
         - `S_OK` - An instance of the specified object class was successfully created.
         
         - ...
       
       - **References:**
         
         - [CoCreateInstance function (combaseapi.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance)
     
     - `VariantInit` - Initializes a variant.
       
       - **Definitions:**
         
         - *Variant* (data type) - data type for all variables that are not explicitly declared as some other type (using statements such as **Dim**, **Private**, **Public**, or **Static**).
       
       - **Synthax:**
         
         - ```c
           void VariantInit(
             [out] VARIANTARG *pvarg
           );
           ```
       
       - **Parameters:**
         
         - `[out] pvarg` - The variant to initialize.
       
       - **Return Values:**
         
         - None.
       
       - **References:**
         
         - [Variant data type | Microsoft Learn](https://learn.microsoft.com/en-us/office/vba/language/reference/user-interface-help/variant-data-type)
         
         - [VariantInit function (oleauto.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/oleauto/nf-oleauto-variantinit)
       
       - ...

1. How does this program achieve persistence?
    - Program doesn’t achieve persistance. Initializes COM object (`OleInitialize`) creates single object with specified clsid (`CoCreateInstance`).
    - `rclsid` and `riid` found in IDA:
        ![Alt text](image.png)
        ```
        .rdata:00402058 rclsid          dd 2DF01h               ; Data1
        .rdata:00402058                                         ; DATA XREF: _main+1D↑o
        .rdata:0040205C                 dw 0                    ; Data2
        .rdata:0040205E                 dw 0                    ; Data3
        .rdata:00402060                 db 0C0h, 6 dup(0), 46h  ; Data4
        .rdata:00402068 ; const IID riid
        .rdata:00402068 riid            dd 0D30C1661h           ; Data1
        .rdata:00402068                                         ; DATA XREF: _main+14↑o
        .rdata:0040206C                 dw 0CDAFh               ; Data2
        .rdata:0040206E                 dw 11D0h                ; Data3
        .rdata:00402070                 db 8Ah, 3Eh, 0, 0C0h, 4Fh, 0C9h, 0E2h, 6Eh; Data4
        ```
    - There are two ways to get GUID value of rclsid and riid (see references below for the alternative version).
      - Conversion through size representation:
        - `rclsid`:
          - dd (define double word, 4 bytes) - 00 02 DF 01 = 0002 DF01
          - dw (define word, 2 bytes) - 00 00 = 0000
          - dw (define word, 2 bytes) - 00 00 = 0000
          - db (define byte, 1 byte) - C0, 000000 46
          - GUID format = {8-4-4-12} =
          **{0002DF01–0000–0000-C000–000000000046}**
          - Searching this id on the web will present us with the microsoft reference page to the `Internet Explorer(Ver 1.0)` AppID.
          - The `rclsid` gets saved in the registry under HKEY_CLASSES_ROOT\CLSID\<ID>.
          - Ref.: https://strontic.github.io/xcyclopedia/library/clsid_0002DF01-0000-0000-C000-000000000046.html
      
      - `riid`:
        - dd (define double word, 4 bytes) - 0D 30 C16 61 = 0D30 C1661
        - dw (define word, 2 bytes) - CD AF = CDAF
        - dw (define word, 2 bytes) - 11 D0 = 11D0
        - db (define byte, 1 byte) - 8A, 3E, 00, C0, 4F, C9, E2, 6E = 00C04FC9E26E
        GUID format = {8-4-4-12} = **{D30C1661-CDAF-11D0–8A3E-00C04FC9E26E}**
        - Searching this id on the web will present us with the microsoft reference page to the `IWebBrowser2` Interface.
        - The `riid` gets saved in the registry under HKEY_CLASSES_ROOT\Interface\<ID>.
        - Ref.: https://learn.microsoft.com/en-us/dotnet/api/microsoft.uii.csr.browser.web.iwebbrowser2?view=dynamics-usd-3
    - After executing the method `CoCreateInstance` one argument `*ppv`     contains the requested interface pointer.
      - ```C
          HRESULT CoCreateInstance(
          [in]  REFCLSID  rclsid,
          [in]  LPUNKNOWN pUnkOuter,
          [in]  DWORD     dwClsContext,
          [in]  REFIID    riid,
          [out] LPVOID    *ppv
        );
        ```
      - The pointer *ppv then gets copied into %eax, and later de-referenced and copied into %edx. Finally 0x2C (44 dec) is added to the de-referenced object.
      ![Alt text](image-1.png)
      - According to the medium.com article (I could not found any microsoft references covering this) the number 44 calls the `Navigate` method in the `IWebBrowser2` struct:
        ```C
        IWebBrowser2 STRUCT
          QueryInterface            DWORD  ?  ;[0] (This,riid,ppvObject)
          AddRef                    DWORD  ?  ;[4] (This)
          Release                   DWORD  ?  ;[8] (This)
          GetTypeInfoCount          DWORD  ?  ;[12] (This,pctinfo)
          GetTypeInfo               DWORD  ?  ;[16] (This,iTInfo,lcid,ppTInfo)
          GetIDsOfNames             DWORD  ?  ;[20] (This,riid,rgszNames,cNames,lcid,rgDispId)
          Invoke                    DWORD  ?  ;[24] (This,dispIdMember,riid,lcid,wFlags,pDispParams,pVarResult,pExcepInfo,puArgErr)
          GoBack                    DWORD  ?  ;[28] (This)
          GoForward                 DWORD  ?  ;[32] (This)
          GoHome                    DWORD  ?  ;[36] (This)
          GoSearch                  DWORD  ?  ;[40] (This)
          Navigate                  DWORD  ?  ;[44] (This,URL,Flags,TargetFrameName,PostData,Headers)
          Refresh                   DWORD  ?  ;[48] (This)
          Refresh2                  DWORD  ?  ;[52] (This,Level)
          Stop                      DWORD  ?  ;[56] (This)
          get_Application           DWORD  ?  ;[60] (This,ppDisp)
          get_Parent                DWORD  ?  ;[64] (This,ppDisp)
          get_Container             DWORD  ?  ;[68] (This,ppDisp)
          get_Document              DWORD  ?  ;[72] (This,ppDisp)
          get_TopLevelContainer     DWORD  ?  ;[76] (This,pBool)
          get_Type                  DWORD  ?  ;[80] (This,Type)
          get_Left                  DWORD  ?  ;[84] (This,pl)
          put_Left                  DWORD  ?  ;[88] (This,Left)
          get_Top                   DWORD  ?  ;[92] (This,pl)
          put_Top                   DWORD  ?  ;[96] (This,Top)
          get_Width                 DWORD  ?  ;[100] (This,pl)
          put_Width                 DWORD  ?  ;[104] (This,Width)
          get_Height                DWORD  ?  ;[108] (This,pl)
          put_Height                DWORD  ?  ;[112] (This,Height)
        ```
        Ref.: https://wasm.in/threads/kak-programmno-vvesti-nik-i-parol-cherez-interfejs-iwebbrowser2.32326/

2. What is the purpose of this program?
    - Program just opens Internet explorer with an advertisement. “http://www.malwareanalysisbook.com/ad.html.”

3. When will this program finish executing?
    - After some cleanup functions: `SysFreeString` and `OleUninitialize` program terminates.


---

References:

- Malware analysis Lab 7 - https://medium.com/@hakingas/malware-analysis-lab-7-6dcb1c1693f7
- Practical Malware Analysis - Solutions of the Book
