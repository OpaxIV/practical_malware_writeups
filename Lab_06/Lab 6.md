# Lab 6

The goal of the labs for this chapter is to help you to understand the overall functionality of a program by analyzing code constructs. Each lab will guide you through discovering and analyzing a new code construct. Each lab builds on the previous one, thus creating a single, complicated piece of malware with four constructs. Once you've finished working through the labs, you should be able to more easly recognize these individual constructs when you encounter them in malware. 

## Lab 6-1

In this lab, you will analyze the malware found in the file Lab06-01.exe.

1. What is the major code construct found in the only subroutine called by `main`?
   
   - `main` is found at 0x401040. If IDA does not recognize the `main` function automatically, commence from `start` until you reach `sub_401040`.
   
   - `main` calls the subroutine `sub_401000`
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-09-12-19-27-image.png)
   
   - **Disassembly:**
     
     - Looking at the subroutine we can see two possible paths, which might be taken. There is a comparasion at the end of the first basic block `.text:00401011 cmp     [ebp+var_4], 0`. Depending if the value in memory is equal to zero a jump occurs.
     
     - If this condition holds true, then a jump to `.text:0040102B loc_40102B:` is taken. On the other hand if `eax`'s value is not 0, then the path on the left is taken starting at 0x401017.
   
   - **Functionality:**
     
     - In the first basic block at 0x401008 we can see a call to the data structure `InternetGetConnectedState`. The return value in `eax` is then copied into memory `[ebp+var_4]` and as stated before compared to 0.
     
     - **FALSE** (red arrow): `.text:00401017 push    offset aSuccessInterne`, hence a successful internet connection has been established.
     
     - **TRUE** (green arrow): `.text:0040102B push    offset aError11NoInter`, error while trying to establish an internet connection.

2. What is the subroutine located at 0x40105F?
   
   - A `printf` function.
   
   - A format string is pushed onto stack on both conditional cases (`Success: Internet Connection\n` and `Error 1.1: No Internet\n`)
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-09-12-40-50-image.png" title="" alt="" width="639">
   
   - `\n` is a newline, used for string outputs.

3. What is the purpose of this program?
   
   - Lab06–01.exe is a simple program to test for internet connection. It utilises API call `InternetGetConnectedState` to determine whether there is internet, and prints an advisory string accordingly.
   
   - In the disassembly we can also see a return value of 1 in `.text:00401024 mov     eax, 1`, if the connection was successful and a 0 in `.text:00401038 xor     eax, eax` if the contrary is the case.

## Lab 6-2

Analyze the malware found in the file Lab06-02.exe.

1. What operation does the first subroutine called my `main` perform?
   
   - `main` function found at 0x00401130.
   
   - Does look very similar to the preceding example from Lab06-01.exe.
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-10-12-30-50-image.png)
   
   - `sub_401000` seems again to have the same functionality as in the Lab06-01.exe file.
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-10-12-31-07-image.png)

2. What is the subroutine located at 0x40117F?
   
   - `sub_40117F` seems again to be a `printf` function (for the same reasons as above).
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-10-12-33-44-image.png" title="" alt="" width="215">
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-10-12-34-03-image.png" title="" alt="" width="655">

3. What does the second subroutine called by `main` do?
   
   - Found at 0x401040
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-10-13-25-47-image.png" title="" alt="" width="493">
   
   - Multiple added conditional statements 
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-10-15-17-00-image.png)
   
   - The first parameter `szAgent` ("Internet Explorer 7.5/pma") is being pushed onto the stack before the API function `InternetOpenA`  is being called.
     
     - `InternetOpenA`: Initializes an application's use of the WinINet functions.
       
       - **Synthax:**
         
         ```c
         HINTERNET InternetOpenA(
           [in] LPCSTR lpszAgent,
           [in] DWORD  dwAccessType,
           [in] LPCSTR lpszProxy,
           [in] LPCSTR lpszProxyBypass,
           [in] DWORD  dwFlags
         );
         ```
       
       - `szAgent`: Pointer to a **null**-terminated string that specifies the name of the application or entity calling the WinINet functions. This name is 
         used as the user agent in the HTTP protocol.
       
       - **Return Value:** Returns a valid handle that the application passes to subsequent WinINet functions. If **InternetOpen** fails, it returns **NULL**. To retrieve a specific error message, call [GetLastError](https://learn.microsoft.com/en-us/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror). 
     
     - Ref.: [InternetOpenA function (wininet.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena)
   
   - After some lines of code the parameter `szUrl` gets pushed onto the stack ("http://www.practicalmalwareanalysis.com/cc.htm") right before the function call to `InternetOpneUrlA`.
     
     - `InternetOpenUrlA`: Opens a resource specified by a complete FTP or HTTP URL.
       
       - **Synthax:**
         
         ```c
         HINTERNET InternetOpenUrlA(
           [in] HINTERNET hInternet,
           [in] LPCSTR    lpszUrl,
           [in] LPCSTR    lpszHeaders,
           [in] DWORD     dwHeadersLength,
           [in] DWORD     dwFlags,
           [in] DWORD_PTR dwContext
         );
         ```
       
       - **Return Value:** Returns a valid handle to the URL if the connection is successfully established, or **NULL** if the connection fails. To retrieve a specific error message, call [GetLastError](https://learn.microsoft.com/en-us/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror). To determine why access to the service was denied, call [InternetGetLastResponseInfo](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-internetgetlastresponseinfoa).
       
       - Ref.: [InternetOpenUrlA function (wininet.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla)
   
   - The API function `InternetReadFile` is called, just after the argument `hFile` is pushed onto the stack.
     
     - `InternetReadFile`: Reads data from a handle opened by the [InternetOpenUrl](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-internetopenurla), [FtpOpenFile](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-ftpopenfilea), or [HttpOpenRequest](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-httpopenrequesta) function.
       
       - **Synthax:**
         
         ```C
         BOOL InternetReadFile(
           [in]  HINTERNET hFile,
           [out] LPVOID    lpBuffer,
           [in]  DWORD     dwNumberOfBytesToRead,
           [out] LPDWORD   lpdwNumberOfBytesRead
         );
         ```
       
       - `hFile`: Handle returned from a previous call to [InternetOpenUrl](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-internetopenurla), [FtpOpenFile](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-ftpopenfilea), or [HttpOpenRequest](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-httpopenrequesta). (basically reading the file given via the URL functions)
       
       - **Return Value:** Returns **TRUE** if successful, or **FALSE** otherwise. To get extended error information, call [GetLastError](https://learn.microsoft.com/en-us/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror). An application can also use [InternetGetLastResponseInfo](https://learn.microsoft.com/en-us/windows/desktop/api/wininet/nf-wininet-internetgetlastresponseinfoa) when necessary.
       
       - Ref.: [InternetReadFile function (wininet.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetreadfile)
   
   - In summary we can see four outcomes of this function (from left to right):
     
     - An error gets thrown, if the given URL can't be opened - if `InternetOpenUrlA` returns 0.
     
     - An error gets thrown, if the File can't be red (specified trough the URL) - if `InternetReadFile` returns 0.
     
     - No error is thrown and the function ends through it's epilogue.
     
     - An error gets thrown, if the command wasn't inputed correctly/the given command is incorrect (The URL was opened correctly and so was the File).
       
       <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-10-15-39-18-image.png" title="" alt="" width="656">

4. What type of code construct is used in this subroutine?
   
   - If `szURl` **is** found, the program attempts to read `200h` (512) bytes of the file (*cc.htm*) using the API call `InternetReadFile` (the `jnz` unsuccessful path leads to “*Error 2.2: Fail to ReadFile\n*” printed and connections closed).
   
   - There are then four `cmp` / `jnz` blocks which each comparing a single byte from the `Buffer` and several variables. These may also be seen as `Buffer+1`, `Buffer+2`,
      etc. This is a notable code construct in which a character array is 
     filled with data from InternetReadFile and is read one by one.
   
   - These values have been converted (by pressing R) to ASCII. Combined these read `<!--`, indicative of the start of a comment in HTML. If the value comparisons are successful, then `var_20C` (likely the whole 512 byes in `Buffer`,
      but just mislabeled by IDA) is read. If at any point a byte read is 
     incorrect, then an alternative path is taken and the string “*Error 2.3: Fail to get command\n*” is printed.
   
   - Looking back at `main`, if this all passes with no issues, the string “*Success: Parsed command is %c\n*” is printed and the system does `Sleep` for 60000 milliseconds (60 seconds) (figure 7). The command printed (displayed through formatting of `%c` is variable `var_8`) is the returned value from `sub_401040`, the contents of *cc.htm.*

5. Are there any network-based indicators for this program?
   
   - The key network-based indicators from the program are the user-agent string and 
   
   - The URL found related to the `InternetOpenA` and `InternetOpenUrlA` calls; *Internet Explorer 7.5/pma* and *http://www.practicalmalwareanalysis.com/cc.htm*

6. What is the purpose of this malware?
   
   - Tests for internet connection
   
   - If connection was successful, the program attempts to download a file from *http://www.practicalmalwareanalysis.com/cc.htm*.
   
   - **Connection is not established:**
     
     - ```batch
       C:\Users\fabio\Downloads\PracticalMalwareAnalysis-Labs-master\PracticalMalwareAnalysis-Labs-master\Practical Malware Analysis Labs\BinaryCollection\Chapter_6L>Lab06-02.exe
       Error 1.1: No Internet
       ```
     
     - Then returns
     
     - Malware has been run in secure environment without access to the internet.
   
   - **Connection is established:**
     
     - ```batch
       C:\Users\fabio\Downloads\PracticalMalwareAnalysis-Labs-master\PracticalMalwareAnalysis-Labs-master\Practical Malware Analysis Labs\BinaryCollection\Chapter_6L>Lab06-02.exe
       Success: Internet Connection
       Error 2.3: Fail to get command
       ```

## Lab 6-3

In this lab, we'll analyze the malware found in the file Lab06-03.exe.

1. Compare the calls in `main` to Lab6-2's `main` method. What is the new function called from `main`?
   
   - Found at `0x401210`
   
   - `main` function in Lab06-02.exe:![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-15-19-52-15-image.png)
   
   - `main` function in Lab06-03.exe:
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-15-19-52-43-image.png)
   
   - Difference notable in the rightmost basic block:
     
     - Lab06-02.exe:
       
       - ```
         .text:0040115C
         .text:0040115C loc_40115C:
         .text:0040115C movsx   ecx, [ebp+var_8]
         .text:00401160 push    ecx
         .text:00401161 push    offset aSuccessParsedC ; "Success: Parsed command is %c\n"
         .text:00401166 call    sub_40117F
         .text:0040116B add     esp, 8
         .text:0040116E push    0EA60h          ; dwMilliseconds
         .text:00401173 call    ds:Sleep
         .text:00401179 xor     eax, eax
         ```
     
     - Lab06-03.exe:
       
       - ```
         .text:0040123C
         .text:0040123C loc_40123C:
         .text:0040123C movsx   ecx, [ebp+var_8]
         .text:00401240 push    ecx
         .text:00401241 push    offset aSuccessParsedC ; "Success: Parsed command is %c\n"
         .text:00401246 call    sub_401271
         .text:0040124B add     esp, 8
         .text:0040124E mov     edx, [ebp+argv]
         .text:00401251 mov     eax, [edx]
         .text:00401253 push    eax             ; lpExistingFileName
         .text:00401254 mov     cl, [ebp+var_8]
         .text:00401257 push    ecx             ; char
         .text:00401258 call    sub_401130
         .text:0040125D add     esp, 8
         .text:00401260 push    0EA60h          ; dwMilliseconds
         .text:00401265 call    ds:Sleep
         .text:0040126B xor     eax, eax
         ```
       
       - Additional function call to `sub_401130` and pushing of the `lpExistingFileName` parameter.

2. What parameters does this new function take?
   
   - ```
     [...]
     .text:00401253 push    eax             ; lpExistingFileName
     .text:00401254 mov     cl, [ebp+var_8]
     .text:00401257 push    ecx             ; char
     .text:00401258 call    sub_401130
     [...]
     ```
   
   - Parameter 1: `lpExistingFileName`
   
   - Parameter 2: `char` (string?)

3. What major code construct does this function contain?
   
   - A jump table, which can also be seen in the nature of the function's graph:
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-15-20-37-11-image.png)
   
   - **First "appearance" at 0x40114A:**
     
     - ```
       .text:00401146 cmp     [ebp+var_8], 4
       .text:0040114A ja      def_401153      ; jumptable 00401153 default case
       ```
     
     - Jumps if `[ebp+var_8]`  >u `4` holds true (unsigned greater than).
     
     - In the case of the statement being **True**, an Error string is printed out "Error 3.2: Not a valid command provided" (jump table default case).
     
     - In the case of being false, we proceed to the jump table located at 0x401150.
   
   - **Jump Table at 0x401150:**
     
     - The location in the jump table, to which the control flow gets redirected is dependent to the value moved into `edx` (probably a command given with the function's call):
       
       ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-15-20-44-43-image.png)
     
     - *Jump Table entry `loc_40115A` at 0x40115A:*
       
       - ```
         .text:0040115A
         .text:0040115A loc_40115A:             ; jumptable 00401153 case 97
         .text:0040115A push    0
         .text:0040115C push    offset PathName ; "C:\\Temp"
         .text:00401161 call    ds:CreateDirectoryA
         .text:00401167 jmp     loc_4011EE
         ```
       
       - Creates a directory with the given pathname.
     
     - *Jump Table entry `loc_40116C` at 0x40116C:*
       
       - ```
         .text:0040116C
         .text:0040116C loc_40116C:             ; jumptable 00401153 case 98
         .text:0040116C push    1
         .text:0040116E push    offset Data     ; "C:\\Temp\\cc.exe"
         .text:00401173 mov     eax, [ebp+lpExistingFileName]
         .text:00401176 push    eax             ; lpExistingFileName
         .text:00401177 call    ds:CopyFileA
         .text:0040117D jmp     short loc_4011EE
         ```
       
       - Copies an existing file `lpExistingFileName` to the specified location at `C:\\Temp\\cc.exe`.
     
     - *Jump Table entry `loc_40117F` at 0x40117F:*
       
       - ```
         .text:0040117F
         .text:0040117F loc_40117F:             ; jumptable 00401153 case 99
         .text:0040117F push    offset Data     ; "C:\\Temp\\cc.exe"
         .text:00401184 call    ds:DeleteFileA
         .text:0040118A jmp     short loc_4011EE
         ```
       
       - Deleted the specified file `C:\\Temp\\cc.exe`
       
       - Ref: [DeleteFileA function (fileapi.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-deletefilea)
     
     - *Jump Table entry `loc_40118C` at 0x40118C:*
       
       - ```
         .text:0040118C
         .text:0040118C loc_40118C:             ; jumptable 00401153 case 100
         .text:0040118C lea     ecx, [ebp+phkResult]
         .text:0040118F push    ecx             ; phkResult
         .text:00401190 push    0F003Fh         ; samDesired
         .text:00401195 push    0               ; ulOptions
         .text:00401197 push    offset SubKey   ; "Software\\Microsoft\\Windows\\CurrentVe"...
         .text:0040119C push    80000002h       ; hKey
         .text:004011A1 call    ds:RegOpenKeyExA
         .text:004011A7 push    0Fh             ; cbData
         .text:004011A9 push    offset Data     ; "C:\\Temp\\cc.exe"
         .text:004011AE push    1               ; dwType
         .text:004011B0 push    0               ; Reserved
         .text:004011B2 push    offset ValueName ; "Malware"
         .text:004011B7 mov     edx, [ebp+phkResult]
         .text:004011BA push    edx             ; hKey
         .text:004011BB call    ds:RegSetValueExA
         .text:004011C1 test    eax, eax
         .text:004011C3 jz      short loc_4011D2
         ```
       
       - Writes a new entry into the Registry (if successful, else an error is printed).
         
         - `RegSetValueEx` function.
           
           - Synthax (general)
             
             - ```c
               LSTATUS RegSetValueExA(
                 [in]           HKEY       hKey,
                 [in, optional] LPCSTR     lpValueName,
                                DWORD      Reserved,
                 [in]           DWORD      dwType,
                 [in]           const BYTE *lpData,
                 [in]           DWORD      cbData
               );
               ```
           
           - Key: `Software\Microsoft\Windows\CurrentVersion\Run`
           
           - Data: `"C:\\Temp\\cc.exe"`
           
           - Name: `Malware`
         
         - Ref: [RegSetValueExA function (winreg.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa)
     
     - *Jump Table entry `loc_4011D4` at 0x4011D4:*
       
       - ```c
         .text:004011D4
         .text:004011D4 loc_4011D4:             ; jumptable 00401153 case 101
         .text:004011D4 push    186A0h
         .text:004011D9 call    ds:Sleep
         .text:004011DF jmp     short loc_4011EE
         ```
       
       - Runs the `Sleep` function.
     
     - All Jump Table cases end up in function's epilogue at 0x4011EE.

4. What can this function do?
   
   - `CopyFile` function:
     
     - `lpExistingFileName` is used in the context of the `CopyFile` function (winbase.h).
     
     - Copies an existing file to a new file.
     
     - **Synthax:**
       
       - ```c
         BOOL CopyFile(
           [in] LPCTSTR lpExistingFileName,
           [in] LPCTSTR lpNewFileName,
           [in] BOOL    bFailIfExists
         );
         ```
     
     - **Parameters:**
       
       - `lpExistingFileName`: The name of an existing file.
       
       - `lpNewFileName`: The name of the new file.
       
       - `bFailIfExists`: If this parameter is **TRUE** and the new file specified by `lpNewFileName` already exists, the function fails. If this parameter is **FALSE** and the new file already exists, the function overwrites the existing file and succeeds.
     
     - **Return Value: **If the function succeeds, the return value is nonzero.
   
   - Ref: [CopyFile function (winbase.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-copyfile)
   
   - Can copy files, create directories and add new registry entries.
     
     - Setting the registry key `Software\Microsoft\Windows\CurrentVersion\Run\Malware` with file `C:\Temp\cc.exe` is a method of persistence to execute the malware on system startup.

5. Are there any host-based indicators for this malware?
   
   - The file written to disk (`C:\Temp\cc.exe`)
   
   - The registry key used for persistence `Software\Microsoft\Windows\CurrentVersion\Run /v Malware | C:\Temp\cc.exe`

6. What is the purpose of this malware?
   
   - Based on similar functionalities like the Lab06–01.exe and Lab06–02.exe executables
   
   - Lab06–03.exe tests for internet connection and prints an appropriate message.
   
   - The program attempts to download and read the file from http://www.practicalmalwareanalysis.com/cc.htm.
   
   - The program then has a set of possible functionalities based upon the contents of *cc.htm* and the `switch` code construct to perform one of:
     
     - - Create directory `C:\Temp`
       - Copy the current file (Lab06–03.exe) to `C:\Temp\cc.exe`
       - Set the Run registry key as `Malware | C:\temp\cc.exe` for persistence
       - Delete `C:\Temp\cc.exe`
       - Sleep the program for 100 seconds

## Lab 6-4

In this lab, we'll analyze the malware found in the file Lab06-04.exe.

1. What is the difference between the calls made from the `main` method in Labs 6-3 and 6-4?
   
   - Found at 0x401230
   
   - `main` function in Lab06-03.exe:
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-16-09-53-54-image.png" title="" alt="" width="472">
   
   - `main` function in Lab06-04.exe:
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-16-09-54-07-image.png" title="" alt="" width="472">
   
   - Contains multiple basic blocks, which were inexistent in the previous Lab06-03.exe file.
   
   - The `main` function of Lab06-04.exe contains no function call to the `downloadFile` function initially. Upon further analysis a modified version at 0x401267 can be found.
     
     - Inside the loop:
       
       ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-16-11-54-49-image.png)
   
   - `downloadFile` (0x401040 in Lab06-04.exe) in Detail:
     
     <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-16-12-06-21-image.png" title="" alt="" width="362">
     
     - The specified `szAgent` is slightly different, with `Internet Explorer 7.5/pma` being replaced with `Internet Explorer 7.50/pma%d`.
     
     - Additionally `arg_0` gets pushed onto the stack and passed to `InternetOpenA`.
       
       - ```
         .text:00401049 mov     eax, [ebp+arg_0]
         .text:0040104C push    eax
         ```
       
       - [InternetOpenA function (wininet.h) - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena)
   
   - Otherwise the `main` function does not seem to contain any further changes.

2. What new code construct has been added to `main`?
   
   - A loop (leftmost returning arrow):
     
     ![](C:\Users\Fabio\AppData\Roaming\marktext\images\2023-12-16-09-59-37-image.png)
   
   - The loop seems to be a for-loop, since it utilizes an initialisation, comparison, execution, and update/incrementation. Seen in C, the for loop would look like the following:
     
     - ```c
       for (initialisation; comparasion; update/incrementation)
       {
           // code to execute
       }
       ```
     
     - In our case the following holds true:
       
       - | Component      | Instruction's Address | Instruction                             | Description                                                                |
         | -------------- | --------------------- | --------------------------------------- | -------------------------------------------------------------------------- |
         | Initialisation | 00401248              | mov [ebp+var_C], 0                      | var_C = 0                                                                  |
         | Comparison     | 0040125A              | cmp     [ebp+var_C], 5A0h               | var_C ? 0x5A                                                               |
         | Incrementation | 00401251 00401254     | mov     eax, [ebp+var_C] add     eax, 1 | var_C += 1                                                                 |
         | Execution      | 00401267 0040129A     | downloadFile regCommandSetter           | Download and read command from the file Execute command using switch cases |

3. What is the difference between this lab's parse HTML function and those of the previous labs?
   
   - The main difference is the addition of the `arg_0` parameter.
   
   - `arg_0` is related to the set of instructions before the function's call:
     
     - ```
       .text:00401263 mov     ecx, [ebp+var_C]
       .text:00401266 push    ec
       .text:00401267 call    downloadFile
       ```
     
     - It is safe to safe, that `var_C` contains a counter, which gets incremented for each loop iteration.

4. How long will this program run? (Assume that it is connected to the Internet.)
   
   - **Technical Aspect:**
     
     - Dependent on the loop
     
     - Until the comparasion at 0x40125A is met:
       
       - ```
         .text:0040125A
         .text:0040125A loc_40125A:
         .text:0040125A cmp     [ebp+var_C], 5A0h
         .text:00401261 jge     short loc_4012AF
         ```
       
       - Hence the (local?) variable `[ebp+var_C]` being greater than 0x5A (90 dec)
   
   - **Time:**
     
     - `Sleep` takes 0xEA60 (60000 ms = 60 sec) as a paremeter, implying as such the sleep duration of 60 sec.
       
       - ```
         .text:004012A2 push    0EA60h          ; dwMilliseconds
         .text:004012A7 call    ds:Sleep
         ```
     
     - The loop is active as long the comparison `.text:0040125A cmp     [ebp+var_C], 5A0h` is false.
       
       - 0x5A0 = 1440 dec
     
     - `var_C` starts at 0 and gets incremented until it reaches 1440 (dec), hence we get a result of 1440 * 60000 ms =  86’400’000 ms = 86’400 sec = 24 h. Imporant to note is the fact, that the `regCommandSetter` function contains also a `Sleep` function, which takes 0x186A0 (100'000 dec & ms) as an argument. So in conclusion we can say, that the execution may even be longer than the original 24 hour time value.

5. Are there any new network-based indicators for this malware?
   
   - `aInternetExplor` “*Internet Explorer 7.50/pma%d”*, with *“http://www.practicalmalwareanalysis.com/cc.htm”* 

6. What is the purpose of this malware?
   
   - Check for an internet connection
   
   - Connects to a C2 domain to retrieve commands and perform specific actions on the host.
   
   - The malware runs for a minimum of 24 hours or at least makes 1440 connections to the C2 domain with 60-second sleep intervals.
   
   - The functionality of the malware allows it to copy itself to a new directory, set it as autorun for persistence by modifying a registry, delete the new file, or sleep for 100 seconds.

---

References:

- https://medium.com/ce-malware-analysis/lab-6-c-code-constructs-in-assembly-e8f22078600c
