# Lab 3

Note: Lab 3 does not seem to work with my Windows 10 machine. I switched to a Windows XP SP3 VM.

## Lab 3-1

Analyze the malware found in the file LAb03-01.exe using basic dynamic analysis tools.

1. What are this malware's imports and strings?
   
   - Malware seems to be **packed**, since only one library (kernel32.dll) and only one  import (ExitProcess) are to be found. On the other hand the Strings are quite clear and not obfuscated.
   
   - **Imports:** *ExitProcess, imported from kernel32.dll*
   
   - **Strings:** *vm32to64.exe, www.practicalmalwareanalysis.com, VideoDriver, WinVM32-, SOFTWARE\Microsoft\Windows\CurrentVersion\Run ...*
   
   - **Sections:**
     
     - **section[0]:** *raw-size of 512 bytes and virtual-size of 104 bytes*
     
     - **section[1]:** *raw-size of 6144 bytes and virtual-size of 5775 bytes*

2. What are the malware's host-based indicators?
   
   - **Process Explorer:**
     
     - **Mutex:** *\BaseNamedObjects\WinVMX32*
     
     - **DLL:** *ws2_32.dll (Windows Socket 2.0 32-bit DLL), ws2help.dll (Windows Socket 2.0 Helper for Windows NT), wshtcpip.dll (Windows Sockets Helper DLL)...*
     
     - Looking at the DLLs revels networking functionality.
   
   - **Process Monitor:**
     
     - **RegSetValue - HLKM\SOFTWARE\Microsoft\Windows\Current\Version\Run\VideoDriver:**
       
       - Under "Data" we can see the C:\\WINDOWS\system32\vmx32to64.exe file being written.
       
       - Since it's under the "Run" folder of the registry, this file is going to be executed every time the user logs in.
     
     - **WriteFile - C:\\\WINDOWS\system32\vmx32to64.exe:**
       
       - Size of 7168 bytes
       
       - Same size as the file Lab03-01.exe

3. Are there any useful network-based signatures for this malware? If so, what are they?
   
   - **INetSim:** DNS connection to www.practicalmalwareanalysis.com
   
   - **Wireshark:** DNS Protocol packets sent from the Windows VM to the Kali VM (INetSim DNS Server) and vice versa.
   
   - **NetCat:** With `nc -l -p 443` and `nc -l -p 80` running, we see some output when looking at port 443. They appear to just be random strings, chaning each time.

## Lab 3-2

Analyze the malware found in the file LAb03-02.dll using basic dynamic analysis tools.

**Static Analysis**

- **PEview:**
  
  - **EXPORT Address Table:**
    
    - Multiple interesting EXPORTS, like "Install", "ServiceMain", "UninstallService", "installA" and "uninstallA".
    
    - "ServiceMain" is the entry point of a service.
  
  - **IMPORT Address Table:**
    
    - HttpSendRequestA, HttpOpenRequestA, CreateProcessA, RegCreateKeyA, RegSetValueExA

- **Strings:**
  
  - www.practicalmalwareanalysis.com
  
  - "serve.html"
  
  - "IPRIP" (enables network communication)

    **Dynamic Analysis**

    Run the .dll file with `rundll32.exe Lab03-02.dll, installA`. It will get installed     as a service (not running yet though).

- **Regshot:**
  
  - New Keys and Values were added.
    
    - `HLKM\SYSTEM\ControlSet001\Services\IPRIP`
    
    - `HLKM\SYSTEM\ControlSet001\Services\IPRIP\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"` - The “**ImagePath**” registry key typically contains the path of the driver’s image file. Hijacking this key with an arbitrary executable will have as a result the payload to run during service start. The malware will be launched inside an svchost.exe process.
    
    - `HLKM\SYSTEM\ControlSet001\Services\IPRIP\DisplayName: "Intranet Network Awareness (INA+)` - could be used as unique fingerprint for identification of the malware
    
    - `HLKM\SYSTEM\ControlSet001\Services\IPRIP\Description: [...]` - could be used as unique fingerprint for identification of the malware

- **Strings (new run):**
  
  - `SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost` and the message "You specify service name not in Svchost//netsvcs, must be one of the following:" implies, that we maybe forgot to add a parameter when we tried to run the malware with `rundll32.exe Lab03-02.dll,InstallA`
  
  - Analyzing the named Registry key will show, that the malware can be run under other services instead of the IPRIP service.<img title="" src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-03-08-20-23-image.png" alt="" width="727" data-align="center">
  
  - Running the malware under `rundll32.exe Lab03-02.dll,InstallA 6to4` will install it under the 6to4 service instead of IPRIP.

Start the malware / IPRIP service with `net start IPRIP`

- **ProcessExplorer:**
  
  - Find --> Find Handle or DLL presents us with the Lab03-02.dll being run under the process svchost.exe with the PID 1096.
  
  - View --> Lower Pane View --> DLLs, click on the process svchost.exe with the ID 1096 and you will see the Lab03-02.dll being loaded.

- **INetSim:**
  
  - DNS connection to www.practicalmalwareanalysis.com

- **NetCat:**
  
  - **Port 80:** Get /serve.html request from www.practicalmalwareanalysis.com
  
  - **User-Agent:** %ComputerName% Windows XP 6.11

References:

- [ImagePath &#8211; Penetration Testing Lab](https://pentestlab.blog/tag/imagepath/)
1. How can you get this malware to install itself?
   
   - `rundll32.exe Lab03-02.dll,installA`

2. How would you get this malware run after installation?
   
   - `net start IPRIP`

3. How can you find the process under which this malware is running?
   
   - svchost.exe

4. Which filters could you set in order to use procmon to glean information?
   
   - Filter the output by using the PID in Process Explorer, which was found trough the Process Manager.

5. What are the malware's host-based indicators?
   
   - Installs itself by default as the service IPRIP.
   
   - Installs itself for persistence in the registry at `HLKM\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters\ServiceDll: "%CurrentDirectory%\Lab03-02.dll"` - The name of the .dll file could be changed, which would lead to a rename of the entry 

6. Are there any useful network-based signatures for this malware?
   
   - DNS connection to [www.practicalmalwareanalysis.com](http://www.practicalmalwareanalysis.com)
   
   - **Port 80:** Get /serve.html request from [www.practicalmalwareanalysis.com](http://www.practicalmalwareanalysis.com)
   
   - **User-Agent:** %ComputerName% Windows XP 6.11

## Lab 3-3

Execute the malware found in the file Lab03-03.exe while monitoring it using basic dynamic analysis tools in a safe environment.

**Static Analysis:**

- **Strings:**
  
  - Nothing really interesting. There seems to be a lot of noise.

- **PEview:**
  
  - **SECTION .rdata - IMPORT Address Table:**
    
    - WriteProcessMemory, CreateProcessA ...
  
  - **SECTION .rdata - EXPORT Address Table:**
    
    - No Export Address Table
  
  - **IMAGE_NT_HEADERS:**
    
    - "Normal looking" sections are to be found.
    
    - Virtual vs raw sizes don't differ immensly

**Dynamic Analysis:**

- **RegShot:**
  
  - Nothing worth mentioning.
  
  - No unusual entries.

- **ProcessExplorer:**
  
  - The malware started with/in the svchost.exe file.
  
  - Process replacement on svchost.exe
  
  - The Lab03-03.exe disappears, but the svchost.exe keeps running in the background as an orphmaned process.
  
  - The process has no father process, even though normally svchost.exe is a child process of services.exe.
  
  - Click on Process --> Properites --> Strings:
    
    - Comparing the Strings in the Image (Disk) and from Memory, we can see that the values differ from each other.
    
    - For example in Memory the Strings `practicalmalwareanalysis.log` and `ENTER` can be found, which are not present on disk.

- **ProcessMonitor:**
  
  - Creates a log file "practicalmalwareanalysis.log" in the directory the malware was run from.
  
  - Using the "Process Name - is - svchost.exe" filter on ProcMon we can see some traffic when writing in a textfile (specifically the process writes into the practicalmalwarenalaysis.log file).
  
  - Writing in an empty text file will lead the program to "copy" the keystrokes into the log file.
  
  - Checking the contents we see, that the program wrote the preciously written characters into the log file:
    
    <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-03-16-32-59-image.png" title="" alt="" width="658">
1. What do you notice when monitoring this malware with Process Explorer?
   
   - The malware started with/in the svchost.exe file.
   
   - Process replacement on svchost.exe
   
   - The Lab03-03.exe disappears, but the svchost.exe keeps running in the background as an orphmaned process.

2. Can you identify any live memory modifications?

3. What are the malware's host-based indicators?
   
   - Creates a log file "practicalmalwareanalysis.log" in the directory the malware was run from.

4. What is the purpose of this program?
   
   - A keylogger, which writes keystrokes into the log file.

## Lab 3-4

Analyze the malware found in the file Lab03-04.exe using basic dynamic analysis tool. (This program is analyzed further in the Chapter 9 labs.)

**Static Analysis:**

- **Strings:**
  
  - **File Manipulation:** "WriteFile", "ReadFile", "CopyFileA"
  
  - **Service Manipulation:** "OpenServiceA" ...
  
  - Command Line Functionality: "shell32.dll" (library containing Windows Shell API functions, which are used when opening web pages and files.), "-cc", "-re", "-in"
  
  - **Networking:** "http://practicalmalwareanalysis.com", "SOFTWARE\Microsoft \XPS", "DOWNLOAD", "UPLOAD" ...

- **PEView:**
  
  - SECTION .rdata - IMPORT Address Table:**
    
    - OpenServiceA, CreateProcessA ...
  
  - **SECTION .rdata - EXPORT Address Table:**
    
    - No Export Address Table
  
  - **IMAGE_NT_HEADERS:**
    
    - "Normal looking" sections are to be found.
    
    - Virtual vs raw sizes don't differ immensly

    **Dynamic Analysis:**

- **Regshot:**
  
  - Nothing unsual to be found.

- **ProcessExplorer:**
  
  - Nothing to see, since the .exe file deletes itself immediately.
  
  - No other process was created, nothing unsual.

- **ProcessMonitor:**
  
  - Deletion can be seen when a filter is applied in ProcMon:
    
    <img src="file:///C:/Users/Fabio/AppData/Roaming/marktext/images/2023-12-03-17-20-38-image.png" title="" alt="" width="648">
1. What happens when you run this file?
   
   - A command line window opens.
   
   - The Lab03-04.exe file disappears (deletes itself).

2. What is causing the roadblock in dynamic analysis?
   
   - Suspicion, that we may need to provide a command-line argument or a missing component to the program.

3. Are there other ways to run this program?
   
   - Even adding the found command-line parameters (Strings) "-cc", "-re" or "-in" does not change the outcome.
