# Lab 11.1
**Disclaimer:**
This analysis might be incomplete. I did my own analysis of the malware without consulting the book (or at least as little as possible). After having finished writing down my thoughts, I read the full analysis found in the book, to compare my results with theirs.

## Initial Foundings

*Lab11-01.exe*
### Running the .exe
The malware runs and drops a file called "msgina.dll" to the disk. Guessing by the name, the file might be used for stealing the credentials when the user tries to log into the system.

### Strings
| String | Group | Functionality |
|---|---|---|
| CreateFile | file | Creates or opens a file or I/O device. |
| ExitProcess | execution | Ends the calling process and all its threads |
| GetActiveWindow | windowing | Retrieves window handle to the active window attached tot eh calling thread's message queue. |
| GetSystemDirectory | reconnaissance | Retrieves the path of the system directory. |
| GinaDLL |  | Operates in the context of the Winlogon process (consult the book for more information) |
| MSGina.dll |  | "" |
| RegCloseKey | registry | Closes a handle to the specified registry key. |
| RegCreateKey(Ex) | registry | Creates the specified registry key. |
| RegSetValueEx | registry | Sets the data and type of a specified value under a registry key. |
| ShellShutdownDialog |  | Some sort of command to shutdown the pc (information is vague) |
| Software\Microsoft\Windows NT\CurrentVersion\Winlogon |  | Provides interactive logon support, Made up of three components the Winlogon Executable, a Graphical Identification and Authentication DLL (GINA), and any number of network providers |
| Wlx[...] (too many to list them all) |  | e.g. WlxNetworkProviderLoad, WlxStartApplication, files used by GINA |
| WriteFile | file | Writes data to the specified file or I/O device. |
| \MsGina |  | "" |
| \msgina32.dll |  | "" |
|  |  |  |
### Imports
- KERNEL32.dll
- ADVAPI32.DLL

*msgina.dll*
### Strings
- Very similar to the prior .exe file.

### Imports
RegSetValueExW<br>
RegCreateKeyW<br>
RegCloseKey<br>
GetSystemDirectoryW<br>
LocalFree<br>
malloc<br>
_wfopen<br>
fclose<br>
ExitProcess<br>
DisableThreadLibraryCalls<br>
LoadLibraryW<br>
FreeLibrary<br>
GetProcAddress<br>
GetModuleFileNameW<br>
FormatMessageW<br>
lstrcatW<br>
lstrlenW<br>
lstrcpyW<br>
_wstrtime<br>
_vsnwprintf<br>
free<br>
_initterm<br>
_adjust_fdiv<br>
_wstrdate<br>
void * __cdecl operator new(unsigned int)<br>
fwprintf<br>
wsprintfA<br>

### Exports (msgina.dll)

DllRegister<br>
DllUnregister<br>
ShellShutdownDialog<br>
WlxActivateUserShell<br>
WlxDisconnectNotify<br>
WlxDisplayLockedNotice<br>
WlxDisplaySASNotice<br>
WlxDisplayStatusMessage<br>
WlxGetConsoleSwitchCredentials<br>
WlxGetStatusMessage<br>
WlxInitialize<br>
WlxIsLockOk<br>
WlxIsLogoffOk<br>
WlxLoggedOnSAS<br>
WlxLoggedOutSAS<br>
WlxLogoff<br>
WlxNegotiate<br>
WlxNetworkProviderLoad<br>
WlxReconnectNotify<br>
WlxRemoveStatusMessage<br>
WlxScreenSaverNotify<br>
WlxShutdown<br>
WlxStartApplication<br>
WlxWkstaLockedSAS<br>


## Static Analysis
### IDA64
#### Lab11-01.exe: main at 0x4011D0
- 0x4011E5 - call to `GetModuleHandleA` (Retrieves a module handle for the specified module) with parameter `LpModuleName` == 0. Since `LpModuleName` is NULL, the function returns a handle to the file used to create the calling process (.exe file).
- 0x4011EB - return value in %eax gets copied into the variable `hModule` (`mov     [ebp+hModule], eax`) and 0 into `FileName` (`mov     [ebp+Filename], 0`) right after it.
- 0x4011F8 - letter "C" (= 0x43) gets copied into %ecx (`mov     ecx, 43h ; 'C'`).
- 0x40120F - call to `sub_401080` with the parameter `hModule` (= the return value of `GetModuleHandleA`)
    - 0x401080 - `jnz     short loc_4010B8`, hModule !=0 hence continue with the normal control flow of the function
    - 0x4010C9 - call to `FindResourceA` (determines location of a resource i.e. with the specified type an identifiable read-only chunk of data embedded in an executable file, and name in the specified module.) with the parameters `lpType`, `lpName` and `hModule`. Returns a handle to the specified resource's information block.





!! 0x4010DF, umbenennen




#### msgina32.dll: main at 0xXXXXX



## Dynamic Analysis

### Procmon


### Registry Checker (?? forgotname, compare reg before and after)


















Analyze the malware found in Lab11-01.exe.
1. What does the malware drop to disk?
- Upon execution, the malware drops the DLL "msgina32.dll".

2. How does the malware achieve persistence?
3. How does the malware steal user credentials?
4. What does the malware do with stolen credentials?
5. How can you use this malware to get user credentials from your test
environment?


---
### References
- Command to Call 'Turn Off Computer' Menu - https://superuser.com/questions/311037/command-to-call-turn-off-computer-menu