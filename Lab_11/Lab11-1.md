# Lab 11.1
**Disclaimer:**
This analysis might be incomplete. I did my own analysis of the malware without consulting the book (or at least as little as possible). After having finished writing down my thoughts, I read the full analysis found in the book, to compare my results with theirs.

## Initial Foundings

*Lab11-01.exe*
### Running the .exe
The malware runs and drops a file called "msgina.dll" to the disk. Guessing by the name, the file might be used for stealing the credentials when the user tries to log into the system.

### Strings
| String | Group | Functionality |
|---|---|---|
| CreateFile | file | Creates or opens a file or I/O device. |
| ExitProcess | execution | Ends the calling process and all its threads |
| GetActiveWindow | windowing | Retrieves window handle to the active window attached tot eh calling thread's message queue. |
| GetSystemDirectory | reconnaissance | Retrieves the path of the system directory. |
| GinaDLL |  | Operates in the context of the Winlogon process (consult the book for more information) |
| MSGina.dll |  | "" |
| RegCloseKey | registry | Closes a handle to the specified registry key. |
| RegCreateKey(Ex) | registry | Creates the specified registry key. |
| RegSetValueEx | registry | Sets the data and type of a specified value under a registry key. |
| ShellShutdownDialog |  | Some sort of command to shutdown the pc (information is vague) |
| Software\Microsoft\Windows NT\CurrentVersion\Winlogon |  | Provides interactive logon support, Made up of three components the Winlogon Executable, a Graphical Identification and Authentication DLL (GINA), and any number of network providers |
| Wlx[...] (too many to list them all) |  | e.g. WlxNetworkProviderLoad, WlxStartApplication, files used by GINA |
| WriteFile | file | Writes data to the specified file or I/O device. |
| \MsGina |  | "" |
| \msgina32.dll |  | "" |
|  |  |  |
### Imports
- KERNEL32.dll
- ADVAPI32.DLL

*msgina.dll*
### Strings
- Very similar to the prior .exe file.

### Imports
RegSetValueExW
RegCreateKeyW
RegCloseKey
GetSystemDirectoryW
LocalFree
malloc
_wfopen
fclose
ExitProcess
DisableThreadLibraryCalls
LoadLibraryW
FreeLibrary
GetProcAddress
GetModuleFileNameW
FormatMessageW
lstrcatW
lstrlenW
lstrcpyW
_wstrtime
_vsnwprintf
free
_initterm
_adjust_fdiv
_wstrdate
void * __cdecl operator new(unsigned int)
fwprintf
wsprintfA

### Exports (msgina.dll)

DllRegister
DllUnregister
ShellShutdownDialog
WlxActivateUserShell
WlxDisconnectNotify
WlxDisplayLockedNotice
WlxDisplaySASNotice
WlxDisplayStatusMessage
WlxGetConsoleSwitchCredentials
WlxGetStatusMessage
WlxInitialize
WlxIsLockOk
WlxIsLogoffOk
WlxLoggedOnSAS
WlxLoggedOutSAS
WlxLogoff
WlxNegotiate
WlxNetworkProviderLoad
WlxReconnectNotify
WlxRemoveStatusMessage
WlxScreenSaverNotify
WlxShutdown
WlxStartApplication
WlxWkstaLockedSAS


## Deeper Analysis
### IDA64




















Analyze the malware found in Lab11-01.exe.
1. What does the malware drop to disk?
- Upon execution, the malware drops the DLL "msgina32.dll".

2. How does the malware achieve persistence?
3. How does the malware steal user credentials?
4. What does the malware do with stolen credentials?
5. How can you use this malware to get user credentials from your test
environment?


---
### References
- Command to Call 'Turn Off Computer' Menu - https://superuser.com/questions/311037/command-to-call-turn-off-computer-menu